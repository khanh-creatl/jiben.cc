local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer
local Camera = game.Workspace.CurrentCamera
local HttpService = game:GetService("HttpService")

-- Biến
local isCamlockEnabled = false
local targetPlayer = nil
local basePredictionFactor = 0.15 -- Hệ số dự đoán cơ bản cho ping cao
local colorChangeSpeed = 0.05 -- Tốc độ đổi màu nút GUI
local highlight = nil
local ping = 0 -- Biến lưu giá trị ping

-- Hàm lấy ping gần đúng
local function getPing()
    local startTime = tick()
    pcall(function()
        HttpService:GetAsync("https://www.roblox.com") -- Gửi request đơn giản để đo độ trễ
    end)
    return (tick() - startTime) * 1000 -- Trả về ping (ms)
end

-- Cập nhật ping mỗi 5 giây
spawn(function()
    while true do
        ping = getPing()
        task.wait(5)
    end
end)

-- Hàm cập nhật highlight
local function updateHighlight()
    if targetPlayer and targetPlayer.Character then
        if highlight then
            highlight:Destroy()
        end
        highlight = Instance.new("Highlight")
        highlight.FillColor = Color3.fromRGB(255, 0, 0)
        highlight.OutlineColor = Color3.fromRGB(255, 0, 0)
        highlight.FillTransparency = 0.5
        highlight.OutlineTransparency = 0
        highlight.Adornee = targetPlayer.Character
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop -- Nhìn xuyên tường
        highlight.Parent = targetPlayer.Character
    end
end

-- Tạo GUI
local function createGui()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
    screenGui.Name = "CamlockGui"
    screenGui.IgnoreGuiInset = true

    -- TextLabel hiển thị trạng thái ON/OFF với hiệu ứng đổi màu
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Size = UDim2.new(0, 100, 0, 50)
    statusLabel.Position = UDim2.new(0.5, -50, 0.85, -25) -- Vị trí phía trên nút
    statusLabel.Text = "OFF"
    statusLabel.BackgroundTransparency = 0.3 -- Nền mờ để đổi màu nổi bật
    statusLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    statusLabel.Font = Enum.Font.SourceSansBold
    statusLabel.TextSize = 20
    statusLabel.Parent = screenGui

    -- Hiệu ứng đổi màu liên tục
    spawn(function()
        while true do
            for i = 0, 1, colorChangeSpeed do
                statusLabel.BackgroundColor3 = Color3.fromHSV(i, 1, 1)
                task.wait()
            end
        end
    end)

    -- Nút toggle ON/OFF
    local toggleButton = Instance.new("TextButton")
    toggleButton.Size = UDim2.new(0, 100, 0, 50)
    toggleButton.Position = UDim2.new(0.5, -50, 0.9, -25) -- Vị trí dưới cùng
    toggleButton.Text = "Toggle"
    toggleButton.BackgroundColor3 = Color3.fromRGB(0, 120, 255) -- Màu xanh cố định
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.Font = Enum.Font.SourceSansBold
    toggleButton.TextSize = 20
    toggleButton.Parent = screenGui

    -- Bật/tắt camlock khi nhấn nút
    toggleButton.MouseButton1Click:Connect(function()
        isCamlockEnabled = not isCamlockEnabled
        statusLabel.Text = isCamlockEnabled and "ON" or "OFF"

        if isCamlockEnabled then
            -- Chọn người chơi gần nhất để khóa
            local closestPlayer = nil
            local closestDistance = math.huge
            local localPos = LocalPlayer.Character and LocalPlayer.Character.HumanoidRootPart.Position

            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
                    local distance = (player.Character.Head.Position - localPos).Magnitude
                    if distance < closestDistance then
                        closestDistance = distance
                        closestPlayer = player
                    end
                end
            end

            targetPlayer = closestPlayer
            updateHighlight()

            -- Theo dõi sự kiện tái sinh của mục tiêu
            if targetPlayer then
                targetPlayer.CharacterAdded:Connect(function(newCharacter)
                    if isCamlockEnabled and targetPlayer == closestPlayer then
                        task.wait() -- Đợi character load hoàn toàn
                        updateHighlight()
                    end
                end)
            end
        else
            -- Tắt highlight khi tắt camlock
            if highlight then
                highlight:Destroy()
                highlight = nil
            end
            targetPlayer = nil
        end
    end)
end

-- Hàm khóa camera vào đầu (siêu dính, không rời)
local function lockCamera()
    if isCamlockEnabled and targetPlayer and targetPlayer.Character and targetPlayer.Character:FindFirstChild("Head") then
        local head = targetPlayer.Character.Head
        local humanoidRootPart = targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        local velocity = humanoidRootPart and humanoidRootPart.Velocity or Vector3.new(0, 0, 0)

        -- Điều chỉnh hệ số dự đoán dựa trên ping
        local adjustedPredictionFactor = basePredictionFactor * (ping > 150 and (ping / 1000) or 0.05)
        local predictedPosition = head.Position + velocity * adjustedPredictionFactor

        -- Khóa camera trực tiếp vào đầu (tức thì, không rung)
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, predictedPosition)
    end
end

-- Khởi tạo GUI
createGui()

-- Kết nối hàm khóa camera với Heartbeat để tối ưu hiệu suất
RunService.Heartbeat:Connect(lockCamera)

-- Thông báo khi script chạy
StarterGui:SetCore("SendNotification", {
    Title = "Camlock Siêu Dính",
    Text = "Camlock loaded! Locks tightly to head, follows respawn. Click to toggle ON/OFF.",
    Duration = 5
})

-- Dịch vụ Roblox
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local GuiService = game:GetService("GuiService")

-- Biến toàn cục
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local CAMLOCK_ENABLED = false
local lockedTarget = nil
local PREDICTION_VELOCITY_LOW = 0.1 -- Giảm để bám chính xác hơn khi ping thấp
local PREDICTION_VELOCITY_HIGH = 0.22 -- Tăng để dự đoán tốt hơn khi ping cao
local LOW_PING_THRESHOLD = 90 -- Ngưỡng ping thấp
local HIGH_PING_THRESHOLD = 200 -- Ngưỡng ping cao
local JUMP_OFFSET = 0.3 -- Tăng bù nhảy
local FALL_OFFSET = 0.3 -- Tăng bù rơi
local AIM_PART = "Head" -- Khóa vào đầu

-- Tạo GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui
ScreenGui.Name = "DNK_Camlock"

-- Tạo khung GUI
local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 150, 0, 120)
Frame.Position = UDim2.new(0.5, -75, 0.1, 0)
Frame.BackgroundTransparency = 0.5
Frame.BackgroundColor3 = Color3.new(0, 0, 0)
Frame.BorderSizePixel = 0
Frame.Parent = ScreenGui
Frame.Active = true

-- Tạo chữ "DNK"
local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 40)
Title.Position = UDim2.new(0, 0, 0, 0)
Title.Text = "DNK"
Title.TextColor3 = Color3.new(1, 1, 1)
Title.TextSize = 30
Title.Font = Enum.Font.SourceSansBold
Title.BackgroundTransparency = 1
Title.Parent = Frame

-- Tạo chữ "ON/OFF"
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, 0, 0, 40)
StatusLabel.Position = UDim2.new(0, 0, 0, 40)
StatusLabel.Text = "OFF"
StatusLabel.TextColor3 = Color3.new(1, 0, 0)
StatusLabel.TextSize = 20
StatusLabel.Font = Enum.Font.SourceSansBold
StatusLabel.BackgroundTransparency = 1
StatusLabel.Parent = Frame

-- Tạo nút ON/OFF
local ToggleButton = Instance.new("TextButton")
ToggleButton.Size = UDim2.new(1, 0, 0, 40)
ToggleButton.Position = UDim2.new(0, 0, 0, 80)
ToggleButton.Text = "Toggle Camlock"
ToggleButton.TextColor3 = Color3.new(1, 1, 1)
ToggleButton.TextSize = 16
ToggleButton.Font = Enum.Font.SourceSansBold
ToggleButton.BackgroundColor3 = Color3.new(0.2, 0.2, 0.2)
ToggleButton.BackgroundTransparency = 0.3
ToggleButton.BorderSizePixel = 0
ToggleButton.Parent = Frame

-- Hiệu ứng đổi màu cầu vồng
local function rainbowColor(t)
    local r = math.sin(t + 0) * 0.5 + 0.5
    local g = math.sin(t + 2) * 0.5 + 0.5
    local b = math.sin(t + 4) * 0.5 + 0.5
    return Color3.new(r, g, b)
end

-- Cập nhật màu GUI liên tục
RunService.RenderStepped:Connect(function(t)
    local time = tick() * 5
    Title.TextColor3 = rainbowColor(time)
    ToggleButton.BackgroundColor3 = rainbowColor(time + 1)
    if CAMLOCK_ENABLED then
        StatusLabel.Text = "ON"
        StatusLabel.TextColor3 = rainbowColor(time + 2)
    else
        StatusLabel.Text = "OFF"
        StatusLabel.TextColor3 = rainbowColor(time + 4)
    end
end)

-- Logic kéo thả GUI
local isDragging = false
local dragStartPos = nil
local frameStartPos = nil

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    if input.UserInputType == Enum.UserInputType.Touch then
        local touchPos = input.Position
        local framePos = Frame.Position
        local frameSize = Frame.AbsoluteSize
        local frameTopLeft = Vector2.new(framePos.X.Offset, framePos.Y.Offset) + Vector2.new(framePos.X.Scale * GuiService:GetScreenResolution().X, framePos.Y.Scale * GuiService:GetScreenResolution().Y)
        if touchPos.X >= frameTopLeft.X and touchPos.X <= frameTopLeft.X + frameSize.X and touchPos.Y >= frameTopLeft.Y and touchPos.Y <= frameTopLeft.Y + frameSize.Y then
            isDragging = true
            dragStartPos = touchPos
            frameStartPos = frameTopLeft
        end
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if isDragging and input.UserInputType == Enum.UserInputType.Touch then
        local touchPos = input.Position
        local delta = touchPos - dragStartPos
        local newPos = frameStartPos + delta
        Frame.Position = UDim2.new(0, newPos.X, 0, newPos.Y)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.Touch then
        isDragging = false
        dragStartPos = nil
        frameStartPos = nil
    end
end)

-- Logic nút ON/OFF
ToggleButton.MouseButton1Click:Connect(function()
    if CAMLOCK_ENABLED then
        CAMLOCK_ENABLED = false
        lockedTarget = nil
        print("Camlock TẮT")
    else
        lockedTarget = getClosestPlayer()
        if lockedTarget then
            CAMLOCK_ENABLED = true
            print("Camlock BẬT - Khóa vào: " .. lockedTarget.Name)
        else
            print("Không tìm thấy mục tiêu!")
        end
    end
end)

-- Hàm kiểm tra ping
local function getPing()
    local ping = game:GetService("Stats").Network.ServerStatsItem["Data Ping"]:GetValue()
    return ping
end

-- Hàm tìm người gần nhất trên màn hình
local function getClosestPlayer()
    local closestPlayer = nil
    local shortestDistance = math.huge
    local screenCenter = Vector2.new(GuiService:GetScreenResolution().X / 2, GuiService:GetScreenResolution().Y / 2)

    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild(AIM_PART) then
            local targetPos = Camera:WorldToViewportPoint(player.Character[AIM_PART].Position)
            if targetPos.Z > 0 then
                local distance = (Vector2.new(targetPos.X, targetPos.Y) - screenCenter).Magnitude
                if distance < shortestDistance then
                    closestPlayer = player
                    shortestDistance = distance
                end
            end
        end
    end
    return closestPlayer
end

-- Hàm dự đoán vị trí mục tiêu
local function predictPosition(target)
    if not target.Character or not target.Character:FindFirstChild(AIM_PART) then
        return nil
    end

    local aimPart = target.Character[AIM_PART]
    local velocity = aimPart.Velocity
    local position = aimPart.Position
    local ping = getPing()
    local predictionVelocity = PREDICTION_VELOCITY_LOW

    if ping >= HIGH_PING_THRESHOLD then
        predictionVelocity = PREDICTION_VELOCITY_HIGH
        local pingFactor = ping / 1000
        position = position + velocity * (predictionVelocity + pingFactor * 0.7) -- Tăng dự đoán cho ping cao
    elseif ping <= LOW_PING_THRESHOLD then
        position = position + velocity * predictionVelocity
    else
        position = position + velocity * (predictionVelocity + (ping / 1000) * 0.4)
    end

    local humanoid = target.Character:FindFirstChild("Humanoid")
    if humanoid then
        if humanoid:GetState() == Enum.HumanoidStateType.Jumping then
            position = position + Vector3.new(0, JUMP_OFFSET * (ping / 1000 + 1), 0)
        elseif humanoid:GetState() == Enum.HumanoidStateType.Freefall then
            position = position - Vector3.new(0, FALL_OFFSET * (ping / 1000 + 1), 0)
        end
    end

    return position
end

-- Hàm cập nhật camera mỗi frame
RunService.RenderStepped:Connect(function()
    if CAMLOCK_ENABLED and lockedTarget and lockedTarget.Character and lockedTarget.Character:FindFirstChild(AIM_PART) then
        local predictedPos = predictPosition(lockedTarget)
        if predictedPos then
            local currentPos = Camera.CFrame.Position
            Camera.CFrame = CFrame.new(currentPos, predictedPos)
        else
            CAMLOCK_ENABLED = false
            lockedTarget = nil
            print("Mất mục tiêu, tắt camlock")
        end
    end
end)

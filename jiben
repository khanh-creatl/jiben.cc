-- Script: DNK Ultimate Aimlock 2025 for Da Hood Hood Z
-- Tác giả: Grok (tạo cho bạn) - Tự động lock kẻ bắn
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local StarterGui = game:GetService("StarterGui")
local VirtualInputManager = game:GetService("VirtualInputManager")
local NetworkClient = game:GetService("NetworkClient")

local player = Players.LocalPlayer
local mouse = player:GetMouse()
local camera = game.Workspace.CurrentCamera
local head = player.Character and player.Character:FindFirstChild("Head")
local humanoid = player.Character and player.Character:FindFirstChild("Humanoid")

-- Thiết lập GUI
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Parent = game.CoreGui
ScreenGui.Name = "DNK_Ultimate"

local Frame = Instance.new("Frame")
Frame.Size = UDim2.new(0, 120, 0, 70) -- GUI 120x70
Frame.Position = UDim2.new(0.5, -60, 0.5, -35)
Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0) -- Nền đen
Frame.BorderSizePixel = 0
Frame.Active = true
Frame.Draggable = true
Frame.Parent = ScreenGui

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 30)
Title.BackgroundTransparency = 1
Title.Text = "DNK"
Title.TextColor3 = Color3.fromRGB(255, 0, 0)
Title.TextSize = 20
Title.TextStrokeTransparency = 0.4
Title.Parent = Frame

local AimlockButton = Instance.new("TextButton")
AimlockButton.Size = UDim2.new(0.85, 0, 0, 25) -- Nút to 0.85x25
AimlockButton.Position = UDim2.new(0.075, 0, 0.55, 0)
AimlockButton.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
AimlockButton.Text = "Aimlock: OFF"
AimlockButton.TextColor3 = Color3.fromRGB(255, 255, 255)
AimlockButton.TextSize = 14
AimlockButton.Parent = Frame

-- Biến trạng thái
local aimlockEnabled = false
local target = nil
local fovRadius = 100 -- FOV ẩn lớn
local lastAmmo = nil
local reloadKey = Enum.KeyCode.R
local lerpSpeed = 0.12
local antiBanDelay = 0.01
local lastAttacker = nil -- Lưu kẻ bắn gần nhất

-- Hàm tạo hiệu ứng gradient mượt mà cho "DNK"
local function updateGradientColor()
    while true do
        local time = tick() * 0.08
        local r = math.sin(time) * 0.4 + 0.6
        local g = math.sin(time + 2.1) * 0.4 + 0.6
        local b = math.sin(time + 4.2) * 0.4 + 0.6
        Title.TextColor3 = Color3.new(r, g, b)
        wait(0.03)
    end
end

spawn(updateGradientColor)

-- Hàm highlight mục tiêu (aura xanh)
local function highlightTarget(targetPlayer)
    if targetPlayer and targetPlayer.Character then
        local highlight = Instance.new("Highlight")
        highlight.FillColor = Color3.fromRGB(0, 255, 0) -- Aura xanh
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 0.3
        highlight.Parent = targetPlayer.Character
        game.Debris:AddItem(highlight, 0.15 + math.random() * antiBanDelay)
    end
end

-- Hàm tìm mục tiêu trong FOV ẩn
local function getTargetInFOV()
    if not head then return nil end
    local screenPosHead, onScreen = camera:WorldToViewportPoint(head.Position)

    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character and otherPlayer.Character:FindFirstChild("Head") then
            local humanoid = otherPlayer.Character:FindFirstChild("Humanoid")
            if humanoid and humanoid.Health > 0 then
                local targetHead = otherPlayer.Character.Head
                local screenPosTarget, onScreenTarget = camera:WorldToViewportPoint(targetHead.Position)
                local distance = (Vector2.new(screenPosTarget.X, screenPosTarget.Y) - Vector2.new(screenPosHead.X, screenPosHead.Y)).Magnitude
                if distance <= fovRadius and onScreenTarget then
                    return otherPlayer
                end
            end
        end
    end
    return nil
end

-- Hàm dự đoán vị trí (tối ưu với ping và jitter)
local function predictPosition(head, velocity, distance)
    local ping = NetworkClient:GetNetworkRoundTripTime() or 0.1
    local dynamicDelay = math.max(0.05, ping + (distance / 200) * 0.05)
    local acceleration = Vector3.new(0, -9.81, 0)
    local recoilOffset = Vector3.new(0, 0.6, 0)
    local jitterOffset = Vector3.new(math.random(-0.3, 0.3), math.random(-0.3, 0.3), 0)
    return head.Position + velocity * dynamicDelay + 0.5 * acceleration * dynamicDelay * dynamicDelay + recoilOffset + jitterOffset
end

-- Hàm kiểm tra và reload thông minh
local function checkAndReload()
    local character = player.Character
    if not character or not aimlockEnabled then return end

    local tool = character:FindFirstChildOfClass("Tool")
    if tool and tool:FindFirstChild("Ammo") then
        local ammo = tool.Ammo.Value
        if ammo <= 0 and lastAmmo ~= 0 then
            lastAmmo = 0
            VirtualInputManager:SendKeyEvent(true, reloadKey, false, game)
            wait(1.5 + math.random() * 0.2)
            VirtualInputManager:SendKeyEvent(false, reloadKey, false, game)
        elseif ammo > 0 then
            lastAmmo = ammo
        end
    else
        if lastAmmo == 0 then
            VirtualInputManager:SendKeyEvent(true, reloadKey, false, game)
            wait(1.5 + math.random() * 0.2)
            VirtualInputManager:SendKeyEvent(false, reloadKey, false, game)
            lastAmmo = 1
        end
    end
end

-- Hàm phát hiện kẻ bắn (giả lập dựa trên sát thương gần nhất)
local function detectAttacker()
    if humanoid and humanoid.Health < 100 then -- Giả định max health là 100
        local character = player.Character
        if character then
            local lastDamageTime = humanoid.LastDamageTime or 0
            if tick() - lastDamageTime < 1 then -- Trong 1 giây gần nhất
                for _, otherPlayer in pairs(Players:GetPlayers()) do
                    if otherPlayer ~= player and otherPlayer.Character and otherPlayer.Character:FindFirstChild("HumanoidRootPart") then
                        local distance = (otherPlayer.Character.HumanoidRootPart.Position - head.Position).Magnitude
                        if distance < 50 then -- Giả định kẻ bắn gần
                            lastAttacker = otherPlayer
                            break
                        end
                    end
                end
            end
        end
    end
end

-- Hàm bật/tắt aimlock và tự động chuyển target
AimlockButton.MouseButton1Click:Connect(function()
    aimlockEnabled = not aimlockEnabled
    AimlockButton.Text = "Aimlock: " .. (aimlockEnabled and "ON" or "OFF")
    if aimlockEnabled then
        if lastAttacker and lastAttacker.Character and lastAttacker.Character:FindFirstChild("Head") and lastAttacker ~= player then
            target = lastAttacker -- Ưu tiên lock kẻ bắn
        else
            target = getTargetInFOV()
        end
        if not target then
            aimlockEnabled = false
            AimlockButton.Text = "Aimlock: OFF"
            StarterGui:SetCore("SendNotification", {
                Title = "DNK Aimlock",
                Text = "No target in FOV or attacker!",
                Duration = 3
            })
        else
            lastAmmo = 1
        end
    else
        target = nil
        lastAttacker = nil
    end
end)

-- Aimlock logic (tự động lock kẻ bắn)
RunService.RenderStepped:Connect(function(deltaTime)
    if aimlockEnabled then
        local fps = 1 / deltaTime
        lerpSpeed = math.clamp(0.1 / fps, 0.05, 0.2)
        detectAttacker() -- Kiểm tra kẻ bắn liên tục
        if target and target.Character and target.Character:FindFirstChild("Head") then
            local head = target.Character.Head
            local humanoid = target.Character:FindFirstChild("Humanoid")
            if humanoid and humanoid.Health <= 0 then
                target = nil -- Chuyển target nếu chết
            elseif lastAttacker and lastAttacker ~= target and lastAttacker.Character and lastAttacker.Character:FindFirstChild("Head") then
                target = lastAttacker -- Chuyển sang kẻ bắn nếu có
            else
                local humanoidRootPart = target.Character:FindFirstChild("HumanoidRootPart")
                if humanoidRootPart then
                    local velocity = humanoidRootPart.Velocity
                    local distance = (head.Position - camera.CFrame.Position).Magnitude
                    local predictedPos = predictPosition(head, velocity, distance)
                    local targetCFrame = CFrame.new(camera.CFrame.Position, predictedPos)
                    camera.CFrame = camera.CFrame:Lerp(targetCFrame, lerpSpeed + math.random() * antiBanDelay)
                else
                    camera.CFrame = camera.CFrame:Lerp(CFrame.new(camera.CFrame.Position, head.Position), lerpSpeed)
                end
                highlightTarget(target)
                checkAndReload()
            end
        else
            target = lastAttacker or getTargetInFOV() -- Ưu tiên kẻ bắn, sau đó FOV
            if not target then
                aimlockEnabled = false
                AimlockButton.Text = "Aimlock: OFF"
                StarterGui:SetCore("SendNotification", {
                    Title = "DNK Aimlock",
                    Text = "Target lost! Aimlock disabled.",
                    Duration = 3
                })
            else
                lastAmmo = 1
            end
        end
    end
end)

-- Thông báo khởi động
StarterGui:SetCore("SendNotification", {
    Title = "DNK Ultimate Aimlock 2025",
    Text = "Loaded for Da Hood! Auto-locks attacker. Click to toggle.",
    Duration = 5
})
